<%- layout("./layouts/boilerplate.ejs")%>
<div class="alert alert-warning text-center">
⏳ Please complete your payment within <span id="timer">07:00</span> minutes.
Otherwise, your booking will expire.
</div>
<div class=" mb-5">
    <div class="col-8 offset-2">
        <h2 class="mb-4">Payment for <%= listing.title %>
        </h2>

        <div class="card p-4 shadow-sm">
            <h5 class="mb-3">Booking Summary</h5>
            <ul class="list-group mb-4">
                <li class="list-group-item d-flex justify-content-between">
                    <span>Stay Duration</span>
                    <span>
                        <%= priceBreakdown.days %> nights
                    </span>
                </li>
                <li class="list-group-item d-flex justify-content-between">
                    <span>Base Cost</span>
                    <span>₹<%= priceBreakdown.baseCost %></span>
                </li>
                <li class="list-group-item d-flex justify-content-between">
                    <span>GST (18%)</span>
                    <span>₹<%= priceBreakdown.gst %></span>
                </li>
                <li class="list-group-item d-flex justify-content-between fw-bold">
                    <span>Total Amount</span>
                    <span>₹<%= priceBreakdown.totalCost %></span>
                </li>
            </ul>

            <div class="text-center mb-4">
                <h5>Scan QR to Pay</h5>
                <img src="<%= qrCodeDataURL %>" alt="UPI QR Code" class="img-fluid" style="max-width:75%;">
                <p class="mt-2"><strong>UPI ID:<%= upiId %></strong> </p>
            </div>

            <form action="/listings/<%= listing._id %>/confirm" method="POST" enctype="multipart/form-data"
                class="mt-3">
                <div class="mb-3">
                    <label for="screenshot" class="form-label">Upload Payment Screenshot</label>
                    <input type="file" class="form-control" name="paymentProof" accept="image/*" required>
                </div>
                <button type="submit" class="btn btn-success w-100">Confirm Booking</button>
            </form>
        </div>
    </div>
</div>

<script>
    // 7 minutes countdown
    let timeLeft = 7 * 60; // in seconds

    function updateTimer() {
        let minutes = Math.floor(timeLeft / 60);
        let seconds = timeLeft % 60;
        document.getElementById("timer").innerText =
            `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

            timeLeft--;
            setTimeout(updateTimer, 1000);
    }

    updateTimer();

  (function () {
    var listingId = "<%= listing._id %>";

    function goFail(reason) {
      window.location.replace("/listings/" + listingId + "/paymentFailed?reason=" + encodeURIComponent(reason));
    }

    //  Detect refresh or back/forward navigation
    window.addEventListener("pageshow", function (evt) {
      if (evt.persisted) return goFail("Back/forward navigation");
      if (performance.getEntriesByType("navigation")[0]?.type === "reload") {
        return goFail("Page refreshed");
      }
    });
  })();


</script>