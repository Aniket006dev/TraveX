<%- layout("./layouts/boilerplate.ejs")%>
<script>
    window.mapToken="<%- process.env.MAPS_API %>"
</script>
    <div class="row mt-3">
        <div class="col-8 offset-2 show-heading">
            <h3>
                <%= list.title%>
            </h3>
        </div>
        <div class="card show-card col-8 offset-2 listing-card">
            <img src="<%= list.image.url%>" alt="listing-img" class="card-img-top show-img">
            <div class="card-body">
                <p class="card-text">Listed by: <b>
                        <%=list.owner.username%>
                    </b></p>
                <hr>
                <p class="card-text">
                    <%= list.description%>
                </p>
                <hr>
                <p class="card-text"> &#8377;<%= list.price.toLocaleString("en-In")%>
                </p>
                <p class="card-text">
                    <%= list.location%>
                </p>
                <p class="card-text">
                    <%= list.country%>
                </p>
            </div>

        </div>
        <%if(currUser && currUser._id.equals(list.owner._id)){%>
            <div class="btns col-8 offset-2 p-0">
                <a href="/listings/<%= list._id%>/edit" class="btn btn-dark update-btn">Edit</a>
                <form action="/listings/<%= list._id%>/delete?_method=DELETE" method="post"><button
                        class="btn btn-dark">Delete</button></form>
            </div>
            <%}%>
                <%if(!currUser){%>
                    <a href="/listings/<%=list._id%>/logged/reviews" class="btn btn-outline-dark col-4 offset-4 mb-3">Leave a
                        review</a>
                    <%}else{%>
                        <hr class="col-8 offset-2 mt-3">
                       <div class="col-8 offset-2">
                            <h5>Tell us your views...</h5>
                            <form action="/listings/<%=list._id%>/reviews" method="post" novalidate
                                class="needs-validation">

                                <label for="rating" class="form-label">Rating</label>    
                                <fieldset class="starability-heart">
                
                                    <input type="radio" id="no-rate" class="input-no-rate" name="review[rating]"
                                        value="1" checked aria-label="No rating." />
                                    <input type="radio" id="first-rate1" name="review[rating]" value="1" />
                                    <label for="first-rate1" title="Terrible">1 star</label>
                                    <input type="radio" id="first-rate2" name="review[rating]" value="2" />
                                    <label for="first-rate2" title="Not good">2 stars</label>
                                    <input type="radio" id="first-rate3" name="review[rating]" value="3" />
                                    <label for="first-rate3" title="Average">3 stars</label>
                                    <input type="radio" id="first-rate4" name="review[rating]" value="4" />
                                    <label for="first-rate4" title="Very good">4 stars</label>
                                    <input type="radio" id="first-rate5" name="review[rating]" value="5" />
                                    <label for="first-rate5" title="Amazing">5 stars</label>
                                </fieldset>

                                <label for="comment">Comments</label>
                                <textarea name="review[comment]" id="comment" class="form-control mb-2" cols="50" rows="5"
                                    placeholder="Have an openion? ,  tell us" required></textarea>
                                <div class="invalid-feedback">Feedback Required !</div>
                                
                                <button class="btn btn-outline-dark mb-3">Submit</button>
                            </form>
                        </div>
                        <%}%>
                        
                            <%if(list.reviews!=""){%>
                                
                                <hr class="col-8 offset-2">
                                <p class="col-8 offset-2"><b>All Reviews</b></p>
                                <div class="col-8 offset-2 px-3">
                                
                                    <div class="row">

                                   
                                        <%for(let data of list.reviews){%>
                                            <div class="card col-md-5 col-lg-4 mb-3 p-2 px-2 me-2" /*style="width: auto";*/>
                                                <div class="card-body">
                                                    <h6 class="card-title"><i>@<%=data.author.username %></i></h6>
                                                    <p class="starability-result card-text mb-2"
                                                        data-rating="<%=data.rating%>">
                                                    </p>
                                                    <p class="card-text mb-2">
                                                        <%= data.comment%>
                                                    </p>
                                                    <p class="card-text"><b>
                                                            <%=data.rating%> stars
                                                        </b></p>
                                                </div>

                                                <%if(currUser && currUser._id.equals(data.author._id)){%>
                                                    <form class="mb-0 mt-3"
                                                        action="/listings/<%=list._id%>/reviews/<%=data._id%>?_method=DELETE"
                                                        method="post">
                                                        <button class="btn btn-dark btn-sm">Delete</button>
                                                    </form>
                                                    <%}%>
                                            </div>
                                            <%}%>
                                     </div>
                                </div>
                                <hr class="col-8 offset-2">
                                <%}%>
                                <div class="col-8 offset-2"> 
                                    <h5>View On Map</h5>
                                </div>
                                <div class="col-8 offset-2 p-0">
                                    
                                    <div id="map" style="height: 50vh;"></div> 
                                     <!-- data-place="<%= list.location %>"    -->
                                    <br>
                                    <br>
                                </div>
                            </div>

<!-- <script src="/js/maps.js"> 
</script>     -->


<script>
  const lat = <%- JSON.stringify(list.coordinates && list.coordinates.lat ? list.coordinates.lat : 0) %>;
  const lng = <%- JSON.stringify(list.coordinates && list.coordinates.lng ? list.coordinates.lng : 0) %>;

  const map = L.map('map').setView([lat, lng], 10);

  L.tileLayer(`https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png`, {
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  L.marker([lat, lng]).addTo(map)
    .bindPopup('<b><%= list.title %></b><br><%= list.location %>')
    .openPopup();
</script>